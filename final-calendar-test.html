<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日历功能测试</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // 紫色为主色调
                        secondary: '#7C3AED', // 辅助色
                        neutral: '#1F2937', // 中性色
                        "neutral-light": '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply hover:bg-neutral-light transition-all;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/20 focus:border-primary;
            }
            .task-completed {
                @apply text-gray-400 line-through;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-gray-800">日历功能测试</h1>
            <p class="text-center text-gray-500 mt-2">这是一个简化版的日历测试，修复了所有已知问题</p>
        </header>

        <!-- 日历视图 -->
        <section id="calendar-view" class="mb-6">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <!-- 日历头部 -->
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-chevron-left text-gray-600"></i>
                    </button>
                    <h3 id="current-month" class="font-medium text-lg"></h3>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-chevron-right text-gray-600"></i>
                    </button>
                </div>
                
                <!-- 日历主体 -->
                <div class="p-4">
                    <!-- 星期标题 -->
                    <div class="grid grid-cols-7 mb-2 whitespace-nowrap">
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">日</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">一</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">二</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">三</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">四</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">五</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-1 h-8 flex items-center justify-center">六</div>
                    </div>
                    
                    <!-- 日历格子 -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- 日历格子将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <!-- 日历底部操作 -->
                <div class="p-4 border-t border-gray-100">
                    <h4 class="font-medium mb-2">今日任务</h4>
                    <div id="today-tasks" class="space-y-2">
                        <!-- 今日任务将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 调试信息 -->
        <div class="bg-gray-800 text-white p-4 rounded-lg text-sm h-64 overflow-auto font-mono mt-6">
            <div id="debug-info">
                调试信息：<br>
            </div>
        </div>
    </div>

    <script>
        // 简单的日志函数，用于在页面上显示输出
        function log(message) {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML += message + '<br>';
            console.log(message);
        }

        // DOM元素
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthElement = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayTasksContainer = document.getElementById('today-tasks');

        // 应用状态
        let tasks = [];
        let currentCalendarDate = new Date();

        // 创建测试任务
        function createTestTasks() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            tasks = [
                {
                    id: Date.now() + 1,
                    text: '测试任务1 - 今天',
                    completed: false,
                    priority: 'high',
                    createdAt: today.toISOString(),
                    dueDate: today.toISOString()
                },
                {
                    id: Date.now() + 2,
                    text: '测试任务2 - 明天',
                    completed: false,
                    priority: 'medium',
                    createdAt: today.toISOString(),
                    dueDate: tomorrow.toISOString()
                },
                {
                    id: Date.now() + 3,
                    text: '测试任务3 - 昨天',
                    completed: true,
                    priority: 'low',
                    createdAt: yesterday.toISOString(),
                    dueDate: yesterday.toISOString()
                },
                {
                    id: Date.now() + 4,
                    text: '测试任务4 - 下周一',
                    completed: false,
                    priority: 'high',
                    createdAt: today.toISOString(),
                    dueDate: new Date(today.getFullYear(), today.getMonth(), today.getDate() + (8 - today.getDay()) % 7).toISOString()
                }
            ];
            
            log(`已创建${tasks.length}个测试任务`);
        }

        // 渲染日历
        function renderCalendar() {
            log('开始渲染日历...');
            
            // 清空日历网格
            calendarGrid.innerHTML = '';
            todayTasksContainer.innerHTML = '';
            
            // 更新当前月份显示
            const options = { year: 'numeric', month: 'long' };
            currentMonthElement.textContent = currentCalendarDate.toLocaleDateString('zh-CN', options);
            log(`当前月份: ${currentMonthElement.textContent}`);
            
            // 获取当月第一天和最后一天
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            log(`月份信息: 年=${year}, 月=${month}, 第一天=${firstDay.toDateString()}, 最后一天=${lastDay.toDateString()}`);
            
            // 获取当月第一天是星期几 (0-6, 0是星期日)
            const firstDayIndex = firstDay.getDay();
            // 获取当月的总天数
            const daysInMonth = lastDay.getDate();
            
            log(`本月第一天是星期${firstDayIndex}, 本月共有${daysInMonth}天`);
            
            // 获取上个月的最后一天
            const prevLastDay = new Date(year, month, 0);
            const prevDaysInMonth = prevLastDay.getDate();
            
            // 渲染上个月的剩余天数
            log(`渲染上个月的${firstDayIndex}天`);
            for (let i = firstDayIndex; i > 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day p-2 text-center border border-gray-100 bg-gray-50 text-gray-400';
                dayElement.textContent = prevDaysInMonth - i + 1;
                calendarGrid.appendChild(dayElement);
            }
            
            // 渲染当月的天数
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            
            log(`渲染当月的${daysInMonth}天, 是否是当前月: ${isCurrentMonth}`);
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                const isToday = isCurrentMonth && today.getDate() === i;
                
                dayElement.className = `calendar-day p-2 border border-gray-100 relative transition-all cursor-pointer hover:bg-gray-50`;
                
                // 如果是今天，添加特殊样式
                if (isToday) {
                    dayElement.classList.add('bg-primary/10', 'font-medium');
                    dayElement.innerHTML = `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-primary text-white">${i}</span>`;
                    log(`今天是${i}号`);
                } else {
                    dayElement.textContent = i;
                }
                
                // 获取当天的任务
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // 修复：确保日期计算正确，特别是对于时区问题
                const dayTasks = tasks.filter(task => {
                    const taskDate = task.dueDate ? new Date(task.dueDate) : new Date(task.createdAt);
                    // 修复：使用toDateString()来比较日期，避免时区问题
                    const taskDateOnly = new Date(taskDate.getFullYear(), taskDate.getMonth(), taskDate.getDate());
                    const currentDateOnly = new Date(year, month, i);
                    return taskDateOnly.toDateString() === currentDateOnly.toDateString();
                });
                
                // 如果当天有任务，添加任务指示器
                if (dayTasks.length > 0) {
                    // 给日期添加特殊背景色表示有任务
                    dayElement.classList.add('bg-blue-50');
                    
                    const tasksIndicator = document.createElement('div');
                    tasksIndicator.className = 'flex gap-1 mt-1 justify-center flex-wrap';
                    
                    // 添加最多3个任务指示器
                    const displayTasks = dayTasks.slice(0, 3);
                    displayTasks.forEach(task => {
                        const taskDot = document.createElement('div');
                        // 根据优先级设置不同颜色
                        let dotColor = 'bg-green-500'; // 低优先级
                        if (task.priority === 'high') {
                            dotColor = 'bg-red-500';
                        } else if (task.priority === 'medium') {
                            dotColor = 'bg-yellow-500';
                        }
                        taskDot.className = `w-2 h-2 rounded-full ${dotColor}`;
                        tasksIndicator.appendChild(taskDot);
                    });
                    
                    // 如果有更多任务，显示省略号
                    if (dayTasks.length > 3) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.className = 'text-xs text-gray-500';
                        moreIndicator.textContent = `+${dayTasks.length - 3}`;
                        tasksIndicator.appendChild(moreIndicator);
                    }
                    
                    dayElement.appendChild(tasksIndicator);
                    log(`第${i}天有${dayTasks.length}个任务`);
                }
                
                // 添加点击事件，显示当天任务
                dayElement.addEventListener('click', () => {
                    showDayTasks(dateStr, i, dayTasks);
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 计算需要补充多少天才能填满日历网格
            const totalDaysRendered = firstDayIndex + daysInMonth;
            const remainingDays = 42 - totalDaysRendered; // 6行7列 = 42个格子
            
            // 渲染下个月的开始天数
            log(`渲染下个月的${remainingDays}天`);
            for (let i = 1; i <= remainingDays; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day p-2 text-center border border-gray-100 bg-gray-50 text-gray-400';
                dayElement.textContent = i;
                calendarGrid.appendChild(dayElement);
            }
            
            // 如果是今天，显示今天的任务
            if (isCurrentMonth) {
                const todayDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const todayTasks = tasks.filter(task => {
                    const taskDate = task.dueDate ? new Date(task.dueDate) : new Date(task.createdAt);
                    return taskDate.toDateString() === today.toDateString();
                });
                showDayTasks(todayDateStr, today.getDate(), todayTasks);
            }
            
            log('日历渲染完成');
        }

        // 显示当天的任务
        function showDayTasks(dateStr, day, tasks) {
            log(`显示${currentCalendarDate.getFullYear()}年${currentCalendarDate.getMonth() + 1}月${day}日的任务，共${tasks.length}个`);
            
            todayTasksContainer.innerHTML = '';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'flex justify-between items-center mb-4';
            dateHeader.innerHTML = `
                <h3 class="text-lg font-medium">${currentCalendarDate.getFullYear()}年${currentCalendarDate.getMonth() + 1}月${day}日 任务</h3>
                <span class="text-sm text-gray-500">共 ${tasks.length} 个任务</span>
            `;
            todayTasksContainer.appendChild(dateHeader);
            
            if (tasks.length === 0) {
                const noTasksElement = document.createElement('div');
                noTasksElement.className = 'text-center py-8 text-gray-500';
                noTasksElement.innerHTML = `
                    <i class="fa fa-calendar-o text-3xl mb-2"></i>
                    <p>当天没有任务</p>
                `;
                todayTasksContainer.appendChild(noTasksElement);
            } else {
                const tasksList = document.createElement('div');
                tasksList.className = 'space-y-2';
                
                tasks.forEach(task => {
                    log(`  - ${task.text} (优先级: ${task.priority}, 完成: ${task.completed})`);
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = `p-3 rounded-lg flex items-center gap-2 ${task.completed ? 'bg-gray-50' : 'bg-white shadow-sm'}`;
                    
                    const checkbox = document.createElement('button');
                    checkbox.className = `w-4 h-4 rounded border-2 flex-shrink-0 flex items-center justify-center transition-colors ${task.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}`;
                    if (task.completed) {
                        checkbox.innerHTML = '<i class="fa fa-check text-white text-xs"></i>';
                    }
                    
                    const taskContent = document.createElement('div');
                    taskContent.className = 'flex-1 min-w-0';
                    const taskText = document.createElement('p');
                    taskText.className = `text-sm ${task.completed ? 'text-gray-400 line-through' : 'text-gray-800'}`;
                    taskText.textContent = task.text;
                    
                    taskContent.appendChild(taskText);
                    taskElement.appendChild(checkbox);
                    taskElement.appendChild(taskContent);
                    tasksList.appendChild(taskElement);
                });
                
                todayTasksContainer.appendChild(tasksList);
            }
        }

        // 切换到上个月
        function goToPreviousMonth() {
            log('切换到上个月');
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        // 切换到下个月
        function goToNextMonth() {
            log('切换到下个月');
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // 初始化应用
        function initApp() {
            log('开始初始化应用...');
            
            // 创建测试任务
            createTestTasks();
            
            // 添加事件监听器
            prevMonthBtn.addEventListener('click', goToPreviousMonth);
            nextMonthBtn.addEventListener('click', goToNextMonth);
            
            // 渲染日历
            renderCalendar();
            
            log('应用初始化完成');
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM加载完成，准备启动应用');
            initApp();
        });
    </script>
</body>
</html>